# 統計的待ち時間算出ロジック - 実装完了報告

## ✅ 実装完了項目

### 1. 統計的待ち時間算出ロジック（TypeScript）
- **ファイル**: `web/src/lib/estimatedWaitTime.ts`
- **機能**: 5つの評価軸（曜日、時間帯、診療科、立地、病院規模）を使用した統計的待ち時間算出
- **出力形式**: 「比較的空きやすい」「やや混みやすい」「混みやすい」+ レンジ表現

### 2. UI統合
- **ファイル**: `web/src/components/search-ui-example.tsx`
- **機能**: 施設詳細ページに統計的待ち時間を表示
- **優先順位**: 実データが5件以上 → 実データを優先、5件未満 → 統計的待ち時間を表示

### 3. データインポート更新
- **ファイル**: `batch/importHospital.js`
- **機能**: CSVファイルから「合計病床数」を取得してインポート

### 4. データベーススキーマ更新
- **ファイル**: `batch/add_bed_count_to_hospital.sql`
- **機能**: `hospital` テーブルに `bed_count` カラムを追加

## ⚠️ 問題提起・確認事項

### 1. データベーススキーマの更新が必要

**問題**: `hospital` テーブルに `bed_count` カラムが存在しない可能性があります。

**対応方法**:
1. SupabaseのSQL Editorで `batch/add_bed_count_to_hospital.sql` を実行
2. `facility_search_view` を更新して `bed_count` を含める（既存のビュー定義を確認してから）

**確認方法**:
```sql
-- hospital テーブルの構造を確認
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'hospital';

-- facility_search_view の定義を確認
SELECT definition 
FROM pg_views 
WHERE viewname = 'facility_search_view';
```

### 2. CSVファイルの再インポートが必要

**問題**: 既にインポート済みのデータには `bed_count` が含まれていません。

**対応方法**:
1. `batch/importHospital.js` を実行して、CSVファイルから `bed_count` を含めて再インポート
2. または、既存データを更新するスクリプトを作成

**注意**: `upsert()` を使用しているため、既存データは更新されず、新規データのみ追加されます。
既存データを更新する場合は、別途更新スクリプトが必要です。

### 3. 診療科情報の取得

**問題**: 現在の実装では、施設詳細ページで診療科が選択されていないため、統計的待ち時間算出時に診療科が `undefined` になっています。

**改善案**:
- 施設詳細ページで診療科を選択できるようにする
- または、`hospital_department` テーブルから主要な診療科を取得して使用

### 4. 都市部・地方の判定ロジック

**問題**: 現在の実装では、都道府県コードのみで判定していますが、より細かい判定（市区町村レベル）が可能です。

**改善案**:
- 市区町村コードを使用して、より細かい立地判定を行う
- 人口密度データを使用して判定する

### 5. 祝日の判定

**問題**: 現在の実装では、日曜日を「祝日」として扱っていますが、実際の祝日は考慮されていません。

**改善案**:
- 祝日API（例: `@holiday-jp/holiday-jp`）を使用して正確な祝日判定を行う

### 6. スコアの調整

**問題**: 現在のスコアは仮定ベースです。実データが蓄積されたら、実際の傾向に合わせて調整する必要があります。

**改善案**:
- 実データから各評価軸の実際の待ち時間を分析
- スコアを実データに基づいて調整

## 📋 次のステップ

### 即座に実行すべきこと

1. **データベーススキーマ更新**
   ```sql
   -- Supabase SQL Editorで実行
   ALTER TABLE hospital ADD COLUMN IF NOT EXISTS bed_count INTEGER;
   ```

2. **CSVファイルの再インポート**
   ```bash
   cd batch
   node importHospital.js
   ```

3. **facility_search_view の更新**
   - 既存のビュー定義を確認
   - `bed_count` を含めるように更新

### 将来的な改善

1. 診療科情報の取得・表示
2. より細かい立地判定
3. 祝日APIの統合
4. 実データに基づくスコア調整

## 🔍 テスト方法

1. 検索ページで病院を検索
2. 施設詳細ページを開く
3. 「公開平均待ち時間」セクションを確認
4. 実データがない場合、「統計的な傾向に基づく目安」が表示されることを確認
5. 注意書き「※ 統計的な傾向に基づく目安です。実際の状況とは異なる場合があります。」が表示されることを確認

## 📝 注意事項

- **医療行為ではない**: あくまで判断支援に留まる
- **クレーム耐性**: レンジ表現と注意書きで対応
- **実データ優先**: 実データが5件以上ある場合は、統計的待ち時間ではなく実データを表示
