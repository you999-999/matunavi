# 統計的待ち時間算出ロジック - 設計ドキュメント

## 概要

実データがない初期状態でも、全ての病院に「統計的に見た待ち時間の目安」をデフォルト表示するためのロジックです。

## 設計思想

- **医療行為ではない**（判断支援に留まる）
- **クレーム耐性が高い**（レンジ・傾向表現）
- **将来、実データが集まったらそちらを優先する設計**

## 評価軸（5項目）

1. **曜日**（平日 / 土曜 / 日祝）
2. **時間帯**（午前 / 午後 / 夕方など）
3. **診療科**（内科・小児科・整形外科など）
4. **病院の立地**（都市部 / 郊外 / 地方 など）
5. **病院の規模**（小規模 / 中規模 / 大規模）

## スコア算出ロジック

各評価軸に0〜100のスコアを設定し、5つの評価軸の平均を計算します。

### スコア設定（数値が高いほど待ち時間が長い傾向）

#### 曜日
- 平日: 50（標準）
- 土曜: 70（やや混みやすい）
- 日祝: 30（比較的空きやすい）

#### 時間帯
- 午前: 80（混みやすい、朝の受診が多い）
- 午後: 60（やや混みやすい）
- 夕方: 40（比較的空きやすい）

#### 診療科
- 内科: 70（混みやすい）
- 小児科: 75（混みやすい、特に午前）
- 整形外科: 65（やや混みやすい）
- 外科: 50（標準）
- 皮膚科: 45（やや空きやすい）
- 眼科: 55（標準）
- 耳鼻咽喉科: 50（標準）
- 泌尿器科: 45（やや空きやすい）
- 産婦人科: 60（やや混みやすい）
- 精神科: 40（比較的空きやすい）
- その他: 50（標準）

#### 立地
- 都市部: 75（混みやすい）
- 郊外: 55（やや混みやすい）
- 地方: 35（比較的空きやすい）

#### 病院規模
- 小規模（20床未満）: 45（やや空きやすい）
- 中規模（20床以上200床未満）: 55（やや混みやすい）
- 大規模（200床以上）: 70（混みやすい）

## 待ち時間レベル判定

平均スコアに基づいて、以下の3段階で判定します：

- **平均スコア < 40**: 「比較的空きやすい」（10〜30分程度）
- **平均スコア 40〜60**: 「やや混みやすい」（30〜60分程度）
- **平均スコア >= 60**: 「混みやすい」（60〜120分程度）

## 出力形式

### テキスト表現
- 「比較的空きやすい（10〜30分程度になりやすい）」
- 「やや混みやすい（30〜60分程度になりやすい）」
- 「混みやすい（60〜120分程度になりやすい）」

### 注意書き
すべての統計的待ち時間表示には、以下の一文を必ず表示します：

> ※ 統計的な傾向に基づく目安です。実際の状況とは異なる場合があります。

## 実データ優先表示の設計

### 判定ロジック

`shouldUseRealData(sampleCount, threshold)` 関数を使用して、実データを優先すべきかどうかを判定します。

- **閾値**: デフォルト5件
- **実データが5件以上**: 実データを優先表示
- **実データが5件未満**: 統計的待ち時間を表示

### 実装例

```typescript
if (shouldUseRealData(averageWaitTime.sample_count)) {
  // 実データを表示
  `${averageWaitTime.avg_wait_minutes}分（サンプル数: ${averageWaitTime.sample_count}件）`
} else {
  // 統計的待ち時間を表示
  const estimated = calculateEstimatedWaitTime(hospitalInfo);
  formatEstimatedWaitTime(estimated);
}
```

## 将来の拡張性

### 実データの蓄積

1. ユーザーからの待ち時間投稿が増える
2. `form_response` テーブルにデータが蓄積される
3. `wait_time_public_avg_view` のサンプル数が増える
4. 自動的に実データが優先表示される

### ロジックの改善

- より詳細な診療科分類
- 季節要因の考慮（インフルエンザシーズンなど）
- 地域別の細かい調整
- 病院の種類別の調整（総合病院 vs 専門病院）

## 注意事項

- **医療的な正確性や保証は不要**
- **「今行くかどうか判断できる」ことを最優先**
- **UI表示で使いやすいシンプルさを重視**
- **クレーム耐性を最優先に設計**
